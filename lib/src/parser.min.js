"use strict";const{constants:constants}=require("http2"),{performance:performance}=require("perf_hooks"),{load:load}=require("cheerio"),{log:log,error:error}=require("console");let Debug=!0;function debugIteration(t,e){Debug&&log(t,+e.toFixed(2))}class Request{static fetcher(t,e){const a=performance.now();return new Promise(((r,o)=>{let n,s,i={[constants.HTTP2_HEADER_SCHEME]:"https",[constants.HTTP2_HEADER_METHOD]:constants.HTTP2_METHOD_GET,[constants.HTTP2_HEADER_PATH]:""},l="";l=(t=new URL(t)).pathname+t.search,/\.to/.test(t.host)?i[constants.HTTP2_HEADER_PATH]=`/${l.replace("/","")}`:i[constants.HTTP2_HEADER_PATH]=l,e||o("ERROR: No connection is made"),e.request(i).on("response",(t=>{if(s=t[":status"],Debug&&log(s),s>400&&(log("Too much internet pawah too fast boi\nstill no proxy to get away with this"),process.exit(0)),s>300&&s<400){let o=t.location.replace("https://nhentai.to/","");i[constants.HTTP2_HEADER_PATH]=`/${o}`,e.request(i).setEncoding("utf8").on("data",(t=>{n+=t})).on("end",(()=>{r(n.replace("undefined","")),debugIteration("[PARSER.JS | FETCHER] redirect took to iterate: ",performance.now()-a)})).end()}})).setEncoding("utf8").on("data",(t=>{n+=t})).on("end",(()=>{200==s&&(r(n.replace("undefined","")),debugIteration("[PARSER.JS | FETCHER] took to iterate: ",performance.now()-a))})).end()}))}}class Parser extends Request{static async Shorter(url,IsDiscord,RRoF,userString,blockedWords,IgnoreNone,client){const start=performance.now(),data=await this.fetcher(url,client),$=load(data),getText=(...t)=>$(...t).text();let IsTo=!1,tags="",title="",titleoc="",titleFull="",titleocFull="",cover="",parodies="",Lang="",Ctg="",Artist="",chr="",Groups="",pages="",dateUploaded="",thumbs="",tagenum=1,Ctgnum=1,parodiesnum=1,Langnum=1,chrnum=1,Artistnum=1,Groupsnum=1,thumbsnum=1,IntArrayTag=1,IntArray=0,text="",regex=/lolicon|shotacon|beastiality|torture|minigirl|blood|guro|cannibalism|shota|loli/,LoopArrayParameter=["parodiesnum","parodies","chrnum","chr","tagenum","tags","Artistnum","Artist","Groupsnum","Groups","Langnum","Lang","Ctgnum","Ctg","end","end"];if(IsTo=/nhentai\.to/.test(url),blockedWords){if("number"==typeof blockedWords)throw"ERROR: 'blockedWords' cannot contain such numbers, It must contain strings.";blockedWords=blockedWords.split(/ |,/g).filter((t=>t)),regex=new RegExp(regex.source.replace("|loli",`|loli|${blockedWords.join("|")}`))}for(;;){if("end"==LoopArrayParameter[IntArray]){let setVar=0;for(;"end"!=LoopArrayParameter[setVar+1];)eval(LoopArrayParameter[setVar+1]+"= eval(LoopArrayParameter[setVar+1]+\".slice(0,-2)||'none'\")"),setVar+=2;break}if("Artistnum"==LoopArrayParameter[IntArray]&&IsDiscord&&((regex.test(tags)||regex.test(userString))&&(text="DISCORD ToS: The doujin picked has a Tag that isn't allowed on Discord\n",RRoF&&regex.test(userString)&&(text="DISCORD ToS: REROLL DENIED\n")),text))throw text;for(;eval(LoopArrayParameter[IntArray])<$(`section#tags>div:nth-child(${IntArrayTag})>span>a`).length+1;)IsTo?eval(LoopArrayParameter[IntArray+1]+" += `${getText(`section#tags>div:nth-child(${IntArrayTag})>span>a:nth-child(${eval(LoopArrayParameter[IntArray])})`)}, `"):eval(LoopArrayParameter[IntArray+1]+" += `${getText(`section#tags>div:nth-child(${IntArrayTag})>span>a:nth-child(${eval(LoopArrayParameter[IntArray])})>span.name`)}, `"),eval(LoopArrayParameter[IntArray]+"++");IntArrayTag+=1,IntArray+=2}if(IsTo?(thumbs=$("div.thumb-container:nth-child(1)>a>img").attr("data-src")||$("div.thumb-container:nth-child(1)>a>img").attr("src").replace("1t.jp",".jp"),title="none",titleoc="none",pages=getText("div#info>div:nth-child(4)"),dateUploaded=getText("div#info>div:nth-child(5)>time")):(thumbs=$("div.thumbs>div:nth-child(1)>a>img").attr("data-src").replace("1t.jp",".jp").replace("t.","i."),title=getText("div#info>h1>span.pretty"),titleoc=getText("div#info>h2>span.pretty"),pages=getText("section#tags>div:nth-child(8)>span>a"),dateUploaded=getText("section#tags>div:nth-child(9)>span")),thumbs=thumbs.replace("undefined",""),titleFull=getText("div#info>h1"),titleocFull=getText("div#info>h2"),cover=$('div[id="cover"]>a>img').attr("data-src")||$('div[id="cover"]>a>img').attr("src"),"404 - Not Found"==title)throw client.close(),"ERROR: ID is not valid please try another ID!";let list={id:url.replace(/\D+/g,""),url:url,title:{origin:titleoc,translated:title,originFull:titleocFull,translatedFull:titleFull},images:{cover:cover,pages_source:thumbs.replace(".jpg",""),pages:t=>(thumbs=thumbs.replace(".jpg",""),t>pages?`That page doesn't exist!\n The total pages are only '${pages}'`:`${thumbs}${t}.jpg`)},tag_table:{parodies:parodies,characters:chr,tag:tags,artist:Artist,groups:Groups,languages:Lang,categories:Ctg},number_pages:pages,uploaded:dateUploaded};if(IgnoreNone)for(let keys of Object.entries(list))if("object"==typeof keys[1])for(let yet of Object.entries(eval(`list.${keys[0]}`)))"none"==yet[1]&&eval(`delete list.${keys[0]}.${yet[0]}`);return debugIteration("[PARSER.JS | SHORTER] took to iterate: ",performance.now()-start),list}static async homePage(t,e,a){let r=`${e}?page=${t}`;const o=await this.fetcher(r,a),n=load(o);let s,i,l,c,g=[];return n("div.index-container>div>a").each(((a,r)=>{s="";let o=r.parent.attribs["data-tags"];(o.match(/\b6346 |\b 6346$/g)||o.match(/\b2 |\b 2$/g)&&/\.to/.test(e))&&(s+="japansese, "),(o.match(/\b29963 |\b 29963$/g)||o.match(/\b10197 |\b 10197$/g)&&/\.to/.test(e))&&(s+="chinese, "),(o.match(/\b12227 |\b 12227$/g)||o.match(/\b19 |\b 19$/g)&&/\.to/.test(e))&&(s+="english, "),(o.match(/\b17249 |\b 17249$/g)||o.match(/\b17 |\b 17$/g)&&/\.to/.test(e))&&(s+="translated, "),0==a&&g.push({CurrentUrl:e.replace(/language\/.*|search\/.*|tag\/.*/,""),typePage:"homepage",CurrentPage:t,Total:c,TotalPage:`${n("section.pagination>a.last").attr("href").replace(/\D+/g,"")}`});for(let t of Object.entries(r.childNodes))"tag"==t[1].type&&("div"==t[1].name&&null!=t[1].children[0].data&&(i=t[1].children[0].data),"img"==t[1].name&&null!=t[1].attribs["data-src"]&&(l=t[1].attribs["data-src"]));g.push({id:+r.attribs.href.replace(/\D+/g,""),title:i,thumbnail:l,url:`${e.replace(/language\/.*|search\/.*|tag\/.*/,"")}g/${r.attribs.href.replace(/\D+/g,"")}`,languages:s.slice(0,-2)}),s="",c=a+1})),g[0].Total=c,/language/.test(e)&&(g[0].typePage="language / "+e.replace(/https:\/\/nhentai\.(to|net)\/language|\//g,"")),/search/.test(e)&&(g[0].typePage="search / "+e.replace(/https:\/\/nhentai\.(to|net)\/search|\?q=|\/|&/g,"")),/tag/.test(e)&&(g[0].typePage="tag / "+e.replace(/https:\/\/nhentai\.(to|net)\/tag|\//g,"")),g}}module.exports={Parser:Parser};
